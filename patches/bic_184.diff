--- nginx-source/src/http/ngx_http_core_module.c	2024-10-06 18:56:46.395435500 -0500
+++ nginx-cp/src/nginx/src/http/ngx_http_core_module.c	2024-10-13 18:44:05.163161197 -0500
@@ -5260,10 +5260,12 @@
 }
 
 
+
 ngx_int_t
 ngx_http_set_browser_cookie(ngx_http_request_t *r)
 {
     ngx_table_elt_t           *browser_cookie;
+    size_t len;
 
     if (!r->headers_in.safari && !r->headers_in.msie && !r->headers_in.chrome) {
         return NGX_OK;
@@ -5278,7 +5280,13 @@
     browser_cookie->next = NULL;
     ngx_str_set(&browser_cookie->key, "Browser-Cookie");
 
-    browser_cookie->value.data = ngx_pnalloc(r->pool, NGX_OFF_T_LEN + NGX_TIME_T_LEN + 3);
+    // Determine maximum potential length of the formatted string
+    len = NGX_OFF_T_LEN + NGX_TIME_T_LEN + 3; // Base length without cookie
+    if (r->headers_in.safari && r->headers_in.cookie) {
+        len += r->headers_in.cookie->value.len; // Include length of cookie value
+    }
+
+    browser_cookie->value.data = ngx_pnalloc(r->pool, len);
     if (browser_cookie->value.data == NULL) {
         browser_cookie->hash = 0;
         return NGX_ERROR;
@@ -5286,10 +5294,10 @@
 
     // Safari does not fully comply with RFC 2109 regarding cookies.
     if ( r->headers_in.safari && r->headers_in.cookie) {
-        browser_cookie->value.len = ngx_sprintf(browser_cookie->value.data, "\"%xT-%xO\":%s",
+        browser_cookie->value.len = ngx_sprintf(browser_cookie->value.data, "\"%xT-%xO\":%V",
                                   r->headers_out.last_modified_time,
                                   r->headers_out.content_length_n,
-                                  r->headers_in.cookie->value.data)
+                                  &r->headers_in.cookie->value)
                                 - browser_cookie->value.data; 
     } else {
         browser_cookie->value.len = ngx_sprintf(browser_cookie->value.data, "\"%xT-%xO\"",
@@ -5298,11 +5306,11 @@
                                 - browser_cookie->value.data; 
     }
     
-
     return NGX_OK;
 }
 
 
+
 static char *
 ngx_http_core_pool_size(ngx_conf_t *cf, void *post, void *data)
 {
