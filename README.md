# GPT-4o for vulnerability detection, PoV and patches Generation
## Build
You should build CP before running py scripts.
```Bash
cd nginx-cp
make cpsrc-prepare
make docker-pull
./run build
```
If build fails, please check this repo for more information: https://github.com/aixcc-public/challenge-004-nginx-cp.

## How to use it
### Run it for specific commit and function
You could run this command to detect the potential Out-of-Bounds Write, and result would be stored in `analysis_result.json`.
```Bash
python3 gpt_for_vuln_detect.py
```
If you already have `analysis_result.json`, you could skip the command above, and run following command to generate payload (or blob). The payload would be stored in `vuln_cpv1.bin`.
```Bash
python3 gpt_for_payload.py --commit_index 165 --func ngx_http_validate_from
```
To genreate patch for a specific function , you could run following command. The diff file would be stored in `bad_patch.diff` or `good_patch.diff`.
```Bash
python3 gpt_for_patch.py --commit_index 165 --func ngx_http_validate_from
```
### Run it for all commits and all suspicious functions
You can run following command with previous record stored in `analysis_result.json`. The result of running this command would be stored in `payloads/` and `patches/` in format `commit_[commit_index]_[func_name]`.
```Bash
python3 crs.py history --disable
```
Or you can run following command without record stored in `analysis_result.json` from scratch.
```Bash
python3 crs.py history --enable
```
One fragment of running `python3 crs.py history --disable` stdout is shown below.
```
Commit 165: ngx_http_validate_from
Try to generate payload #1
Failed...
Try to generate payload #2
Failed...
Try to generate payload #3
Failed...
Try to generate payload #4
Failed...
Try to generate payload #5
Payload generates successfully in vuln_cpv1.bin!

Try to generate patch #1
Patch the vuln successfully!
Run functionality tests...
All functionality tests passed, good patch!

Commit 165: ngx_http_process_from
Try to generate payload #1
Failed...
Try to generate payload #2
Failed...
Try to generate payload #3
Failed...
Try to generate payload #4
Failed...
Try to generate payload #5
Failed...
Try to generate payload #6
Failed...
Try to generate payload #7
Failed...
Try to generate payload #8
Failed...
Try to generate payload #9
Failed...
Try to generate payload #10
Failed...
Payload generation terminates.
```
## Result for finding CPV1 (induced by Commit 165)
There are avaiable payload and good_patch.diif that are generated by GPT-4o.  
payload:
```http
GET / HTTP/1.1
Host: localhost
From: johndoe..1234567890@aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb.com
```
good_patch.diff
```c
--- nginx-source/src/http/ngx_http_request.c	2024-10-06 18:56:46.395435500 -0500
+++ nginx-cp/src/nginx/src/http/ngx_http_request.c	2024-10-07 22:25:56.632527516 -0500
@@ -4038,10 +4038,11 @@
 }
 
 
-static ngx_int_t
+static 
+ngx_int_t
 ngx_http_validate_from(ngx_str_t *from, ngx_pool_t *pool, ngx_uint_t alloc)
 {
-    u_char  *f, *u, ch;
+    u_char  *f, *u, *u_start, ch;
     size_t   i;
 
     enum {
@@ -4053,29 +4054,28 @@
     } state;
 
     f = from->data;
-
     state = sw_begin;
 
     if (alloc) {
-        u = ngx_palloc(pool, from->len);
-
+        u = ngx_palloc(pool, from->len + 1);   // +1 for the terminating null byte
         if (u == NULL) {
             return NGX_ERROR;
         }
+        u_start = u;
     } else {
         u = from->data;
+        u_start = u;
     }
 
     for (i = 0; i < from->len; i++) {
         ch = f[i];
 
         switch (state) {
-
         case sw_begin:
             if (isalnum(ch) || ch == '-' || ch == '_') {
                 state = sw_username;
             } else if (ch == '.') {
-                state = sw_username_dot;
+                return NGX_DECLINED; // Dots can't appear at the beginning
             } else {
                 return NGX_DECLINED;
             }
@@ -4087,16 +4087,7 @@
                 *u++ = ch;
                 state = sw_username;
             } else if (ch == '.') {
-                state = sw_username_dot;
-                u -= 2;
-                for ( ;; ) {
-                    if (*u == '.') {
-                        u++;
-                        break;
-                    }
-
-                    u--;
-                }
+                return NGX_DECLINED; // Consecutive dots not allowed
             } else {
                 return NGX_DECLINED;
             }
@@ -4130,7 +4121,6 @@
             break;
 
         default:
-
             return NGX_DECLINED;
         }
     }
@@ -4139,7 +4129,7 @@
         *u = '\0';
 
         if (alloc) {
-            from->data = u;
+            from->data = u_start;
         }
         return NGX_OK;
     } else {

```
Before patch:
```
INFO: Running with entropic power schedule (0xFF, 100).
INFO: Seed: 3436198775
INFO: Loaded 1 modules   (80 inline 8-bit counters): 80 [0x563d32fd9d78, 0x563d32fd9dc8), 
INFO: Loaded 1 PC tables (80 PCs): 80 [0x563d32fd9dc8,0x563d32fda2c8), 
/out/pov_harness: Running 1 inputs 100 time(s) each.
Running: /work/tmp_blob
=================================================================
==39==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x51000000013f at pc 0x563d32d9c784 bp 0x7fffad746d00 sp 0x7fffad746cf8
READ of size 1 at 0x51000000013f thread T0
    #0 0x563d32d9c783 in ngx_http_validate_from /src/harnesses/bld/src/http/ngx_http_request.c:4093:25
    #1 0x563d32d9c783 in ngx_http_process_from /src/harnesses/bld/src/http/ngx_http_request.c:4170:9
    #2 0x563d32dab15a in ngx_http_process_request_headers /src/harnesses/bld/src/http/ngx_http_request.c:1499:23
    #3 0x563d32d40bdc in ngx_event_process_posted /src/harnesses/bld/src/event/ngx_event_posted.c:34:9
    #4 0x563d32cdba37 in LLVMFuzzerTestOneInput /src/harnesses/bld/src/harnesses/pov_harness.cc:323:5
    #5 0x563d32b8d780 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13
    #6 0x563d32b77f14 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6
    #7 0x563d32b7d9aa in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9
    #8 0x563d32ba9da2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10
    #9 0x7f35a8191082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 0702430aef5fa3dda43986563e9ffcc47efbd75e)
    #10 0x563d32b6e9ed in _start (/out/pov_harness+0xb59ed)

0x51000000013f is located 1 bytes before 184-byte region [0x510000000140,0x5100000001f8)
allocated by thread T0 here:
    #0 0x563d32c9bd1e in malloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:69:3
    #1 0x563d32d4c5f4 in ngx_alloc /src/harnesses/bld/src/os/unix/ngx_alloc.c:22:9
    #2 0x563d32ce37eb in ngx_palloc_large /src/harnesses/bld/src/core/ngx_palloc.c:220:9
    #3 0x563d32d9c359 in ngx_http_validate_from /src/harnesses/bld/src/http/ngx_http_request.c:4060:13
    #4 0x563d32d9c359 in ngx_http_process_from /src/harnesses/bld/src/http/ngx_http_request.c:4170:9
    #5 0x563d32dab15a in ngx_http_process_request_headers /src/harnesses/bld/src/http/ngx_http_request.c:1499:23
    #6 0x563d32d40bdc in ngx_event_process_posted /src/harnesses/bld/src/event/ngx_event_posted.c:34:9
    #7 0x563d32cdba37 in LLVMFuzzerTestOneInput /src/harnesses/bld/src/harnesses/pov_harness.cc:323:5
    #8 0x563d32b8d780 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:614:13
    #9 0x563d32b77f14 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned long) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:327:6
    #10 0x563d32b7d9aa in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:862:9
    #11 0x563d32ba9da2 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10
    #12 0x7f35a8191082 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x24082) (BuildId: 0702430aef5fa3dda43986563e9ffcc47efbd75e)

SUMMARY: AddressSanitizer: heap-buffer-overflow /src/harnesses/bld/src/http/ngx_http_request.c:4093:25 in ngx_http_validate_from
Shadow bytes around the buggy address:
  0x50fffffffe80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x50ffffffff00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x50ffffffff80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x510000000000: fa fa fa fa fa fa fa fa 00 00 00 00 00 00 00 00
  0x510000000080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 fa
=>0x510000000100: fa fa fa fa fa fa fa[fa]00 00 00 00 00 00 00 00
  0x510000000180: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 fa
  0x510000000200: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x510000000280: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x510000000300: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x510000000380: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==39==ABORTING
libfuzzer exit=1
```

After patch:
```
INFO: Running with entropic power schedule (0xFF, 100).
INFO: Seed: 3832608203
INFO: Loaded 1 modules   (80 inline 8-bit counters): 80 [0x563e90cf5d78, 0x563e90cf5dc8), 
INFO: Loaded 1 PC tables (80 PCs): 80 [0x563e90cf5dc8,0x563e90cf62c8), 
/out/pov_harness: Running 1 inputs 100 time(s) each.
Running: /work/tmp_blob
Executed /work/tmp_blob in 23 ms
***
*** NOTE: fuzzing was not performed, you have only
***       executed the target code on a fixed set of inputs.
***
libfuzzer exit=0
```